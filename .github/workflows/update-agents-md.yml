name: Weekly AGENTS.md Update

on:
  schedule:
    # 毎週月曜日の午前9時(JST)に実行（UTC 0:00）
    - cron: "0 0 * * 1"
  workflow_dispatch: # 手動トリガーも可能にする

jobs:
  update-agents-md:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # 完全な履歴を取得（探索に必要）

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING_PR=$(gh pr list --head "claude/update-agents-md" --state open --json number,url --jq '.[0] // empty')
          if [ -n "$EXISTING_PR" ]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            PR_URL=$(echo "$EXISTING_PR" | jq -r '.url')
            echo "pr_exists=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          else
            echo "pr_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Claude to update AGENTS.md
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: "60"
          prompt: |
            REPOSITORY: ${{ github.repository }}
            BRANCH: main
            EXISTING_PR: ${{ steps.check-pr.outputs.pr_exists }}
            EXISTING_PR_NUMBER: ${{ steps.check-pr.outputs.pr_number }}

            ## タスク
            このプロジェクトの構成と利用技術を包括的に探索し、AGENTS.mdファイルを最新の状態に更新してください。

            ## 探索項目
            1. **依存関係**: package.json のバージョン情報（Next.js, React, pnpm等）
            2. **ディレクトリ構造**: src/ 配下のファイル・ディレクトリ構成
            3. **設定ファイル**: tsconfig.json, next.config.ts, biome.json等
            4. **スクリプト**: package.json のscriptsセクション
            5. **コンポーネント**: components/ ディレクトリ内の主要コンポーネント
            6. **App Router**: app/ ディレクトリの構成

            ## 実行ルール
            - AGENTS.mdの内容を現在のプロジェクト状態と比較してください
            - **変更が必要ない場合**:
              - EXISTING_PRが"true"の場合: PR #${{ steps.check-pr.outputs.pr_number }} はもう不要です。`gh pr close ${{ steps.check-pr.outputs.pr_number }} --comment "AGENTS.mdは最新の状態のため、このPRをクローズします。"` を実行してクローズしてください。
              - EXISTING_PRが"false"の場合: 何もせず終了してください（コミット不要）
            - **変更がある場合**:
              1. AGENTS.mdファイルを更新
              2. 変更内容を確認
              3. ブランチ名は固定で `claude/update-agents-md` を使用してください
              4. mainブランチから `claude/update-agents-md` ブランチを作成（既にローカルに存在する場合は削除してから再作成）:
                 ```
                 git checkout main
                 git branch -D claude/update-agents-md 2>/dev/null || true
                 git checkout -b claude/update-agents-md
                 ```
              5. 変更をコミット（コミットメッセージ: "docs: update AGENTS.md with latest project configuration"）
              6. ブランチをpush（`git push --force-with-lease origin claude/update-agents-md`）
              7. EXISTING_PRが"true"の場合:
                 - PRは既に存在するため、新しいPRを作成しないでください
                 - PR #${{ steps.check-pr.outputs.pr_number }} の説明を更新してください:
                   `gh pr edit ${{ steps.check-pr.outputs.pr_number }} --body "変更された項目の具体的な概要"`
              8. EXISTING_PRが"false"の場合:
                 - 新しいPull Requestを作成してください
                 - PRのタイトル: "docs: update AGENTS.md with latest project configuration"
                 - PRの説明: 変更された項目の具体的な概要を記載（バージョン変更、新規コンポーネント追加など）

            ## 重要な注意事項
            - 既存のファイル構造とフォーマットを維持してください
            - 日本語の表現や技術用語を適切に保ってください
            - プロジェクトの実態を正確に反映してください
            - 変更がない場合はコミットを作成しないでください
            - ブランチ名は必ず `claude/update-agents-md`（タイムスタンプなし）を使用してください
          claude_args: |
            --allowedTools Read,Glob,Grep,Edit,Write,Bash(git:*),Bash(gh pr:*),Bash(pnpm:*),Bash(date:*)
